(function(){"use strict";var STAGE="Stage",STRING="string",PX="px",MOUSEOUT="mouseout",MOUSELEAVE="mouseleave",MOUSEOVER="mouseover",MOUSEENTER="mouseenter",MOUSEMOVE="mousemove",MOUSEDOWN="mousedown",MOUSEUP="mouseup",CLICK="click",DBL_CLICK="dblclick",TOUCHSTART="touchstart",TOUCHEND="touchend",TAP="tap",DBL_TAP="dbltap",TOUCHMOVE="touchmove",DOMMOUSESCROLL="DOMMouseScroll",MOUSEWHEEL="mousewheel",WHEEL="wheel",CONTENT_MOUSEOUT="contentMouseout",CONTENT_MOUSEOVER="contentMouseover",CONTENT_MOUSEMOVE="contentMousemove",CONTENT_MOUSEDOWN="contentMousedown",CONTENT_MOUSEUP="contentMouseup",CONTENT_CLICK="contentClick",CONTENT_DBL_CLICK="contentDblclick",CONTENT_TOUCHSTART="contentTouchstart",CONTENT_TOUCHEND="contentTouchend",CONTENT_DBL_TAP="contentDbltap",CONTENT_TAP="contentTap",CONTENT_TOUCHMOVE="contentTouchmove",DIV="div",RELATIVE="relative",KONVA_CONTENT="konvajs-content",SPACE=" ",UNDERSCORE="_",CONTAINER="container",EMPTY_STRING="",EVENTS=[MOUSEDOWN,MOUSEMOVE,MOUSEUP,MOUSEOUT,TOUCHSTART,TOUCHMOVE,TOUCHEND,MOUSEOVER,DOMMOUSESCROLL,MOUSEWHEEL,WHEEL],eventsLength=EVENTS.length;Konva.Stage.prototype._touchstart=function(evt){var changedTouches=evt.changedTouches;var cLength=changedTouches.length;for(var i=0;i<cLength;i++){var touchEvent=changedTouches[i];var contentPosition=this._getContentPosition();this.pointerPos={x:touchEvent.clientX-contentPosition.left,y:touchEvent.clientY-contentPosition.top};var shape=this.getIntersection(this.getPointerPosition());Konva.listenClickTap=true;if(shape&&shape.isListening()){this.tapStartShape=shape;shape._fireAndBubble(TOUCHSTART,{evt:evt});if(shape.isListening()&&evt.preventDefault){evt.preventDefault()}}this._fire(CONTENT_TOUCHSTART,{evt:evt})}};Konva.Stage.prototype._touchend=function(evt){var changedTouches=evt.changedTouches;var cLength=changedTouches.length;for(var i=0;i<cLength;i++){var touchEvent=changedTouches[i];var contentPosition=this._getContentPosition();this.pointerPos={x:touchEvent.clientX-contentPosition.left,y:touchEvent.clientY-contentPosition.top};var shape=this.getIntersection(this.getPointerPosition()),fireDblClick=false;if(Konva.inDblClickWindow){fireDblClick=true;Konva.inDblClickWindow=false}else{Konva.inDblClickWindow=true}setTimeout(function(){Konva.inDblClickWindow=false},Konva.dblClickWindow);if(shape&&shape.isListening()){shape._fireAndBubble(TOUCHEND,{evt:evt});if(Konva.listenClickTap&&shape._id===this.tapStartShape._id){shape._fireAndBubble(TAP,{evt:evt});if(fireDblClick){shape._fireAndBubble(DBL_TAP,{evt:evt})}}if(shape.isListening()&&evt.preventDefault){evt.preventDefault()}}this._fire(CONTENT_TOUCHEND,{evt:evt});if(Konva.listenClickTap){this._fire(CONTENT_TAP,{evt:evt});if(fireDblClick){this._fire(CONTENT_DBL_TAP,{evt:evt})}}Konva.listenClickTap=false}};Konva.Stage.prototype._touchmove=function(evt){var changedTouches=evt.changedTouches;var cLength=changedTouches.length;for(var i=0;i<cLength;i++){var touchEvent=changedTouches[i];var contentPosition=this._getContentPosition();this.pointerPos={x:touchEvent.clientX-contentPosition.left,y:touchEvent.clientY-contentPosition.top};var dd=Konva.DD,shape;if(!Konva.isDragging()){shape=this.getIntersection(this.getPointerPosition());if(shape&&shape.isListening()){shape._fireAndBubble(TOUCHMOVE,{evt:evt});if(shape.isListening()&&evt.preventDefault){evt.preventDefault()}}this._fire(CONTENT_TOUCHMOVE,{evt:evt})}if(dd){if(Konva.isDragging()){evt.preventDefault()}}}}})();var Gamepad=function(){"use strict";var wsUri="ws://"+location.host+"/index.html?command=true";var wsUri="ws://"+"192.168.1.92"+"/index.html?command=true";var statusText;var gpDataCmds;var gpButtons;var gpAccel;var gpJoysticks;function writeMessage(message){statusText.setText(message);Controller.layer.draw()}function _init_controllers(stage,layer){Controller.init({stage:stage,layer:layer,rotated:true});var joy_left=new Controller.Joystick1a({x:130,y:300,length:200,breadth:70,padding:20,spring:true,horizontal:true,on_move:function(pos){gpJoysticks[0]=Math.round(pos*100);writeMessage(pos.toFixed(2))}});var joy_right=new Controller.Joystick1a({x:500,y:200,length:200,breadth:70,padding:20,spring:true,horizontal:false,on_move:function(pos){gpJoysticks[1]=Math.round(pos*100);writeMessage(pos.toFixed(2))}});var btn1=new Controller.Button({x:100,y:100,on_press:function(btn){btn.setState(!btn.state);gpButtons=gpButtons^1}});var btn2=new Controller.Button({x:200,y:100,on_press:function(btn){btn.setState(!btn.state);gpButtons=gpButtons^2}});statusText=new Konva.Text({x:10,y:10,fontFamily:"Calibri",fontSize:24,text:"",fill:"black"});layer.add(statusText);layer.add(joy_left.shape);layer.add(joy_right.shape);layer.add(btn1.shape);layer.add(btn2.shape)}function deviceOrientationListener(event){gpAccel[0]=Math.round(event.alpha);gpAccel[1]=Math.round(event.beta);gpAccel[2]=Math.round(event.gamma)}function _init(){var width=window.innerWidth;var height=window.innerHeight;gpDataCmds=new ArrayBuffer(20);var gpHeader=new Uint32Array(gpDataCmds,0,1);gpHeader[0]=286397204;gpButtons=new Uint16Array(gpDataCmds,4,1);gpAccel=new Int16Array(gpDataCmds,6,3);gpJoysticks=new Int8Array(gpDataCmds,12,4);var stage=new Konva.Stage({container:"container",x:width,rotation:90,width:width,height:height});var layer=new Konva.Layer;_init_controllers(stage,layer);stage.add(layer);if(window.DeviceOrientationEvent){window.addEventListener("deviceorientation",deviceOrientationListener)}wsComm.init(wsUri,function(data){});var interval=setInterval(function(){wsComm.send(gpDataCmds)},100)}return{init:_init}}();var Controller=Controller||{};(function(){"use strict";var vec_normalize=function(v){var dist2=v.x*v.x+v.y*v.y;var dist=Math.sqrt(dist2);return{vn:{x:v.x/dist,y:v.y/dist},mag:dist}};var coerce=function(x,min,max){if(x<min)x=min;if(x>max)x=max;return x};Controller.init=function(config){Controller.rotated=config.rotated||false;Controller.stage=config.stage;Controller.layer=config.layer};Controller.getPointerRelativePosition=function(obj){var touchPos=Controller.stage.getPointerPosition();var ap=obj.getAbsolutePosition();var rx=touchPos.x-ap.x;var ry=touchPos.y-ap.y;if(Controller.rotated){return{x:ry,y:-rx}}else{return{x:rx,y:ry}}};Controller.Joystick=function(config){var default_args={size:60,spring:false,on_move:function(pos){}};for(var index in default_args){if(typeof config[index]==="undefined")config[index]=default_args[index]}config.size_inner=config.size_inner||config.size*.5;var that=this;this.pos={x:0,y:0};this.shape=new Konva.Group({x:config.x,y:config.y});var back=new Konva.Rect({width:config.size,height:config.size,offsetX:config.size/2,offsetY:config.size/2,fill:"gray",strokeWidth:0,opacity:.1});var back_drawn=new Konva.Rect({width:config.size_inner,height:config.size_inner,offsetX:config.size_inner/2,offsetY:config.size_inner/2,fill:"gray",strokeWidth:0,listening:false});var nub=new Konva.Circle({x:0,y:0,radius:config.size/10,fill:"black",strokeWidth:0,listening:false});back.on("mousemove touchmove",function(){var pos=Controller.getPointerRelativePosition(that.shape);pos.x=coerce(pos.x,-config.size_inner/2,config.size_inner/2);pos.y=coerce(pos.y,-config.size_inner/2,config.size_inner/2);that.pos={x:2*pos.x/config.size_inner,y:-2*pos.y/config.size_inner};config.on_move(that.pos);nub.position(pos);Controller.layer.draw()});back.on("mouseup touchend",function(){that.pos={x:0,y:0};config.on_move(that.pos);nub.position(that.pos);Controller.layer.draw()});this.shape.add(back);this.shape.add(back_drawn);this.shape.add(nub)};Controller.Joystick1a=function(config){var default_args={length:100,breadth:30,padding:30,horizontal:false,spring:false,on_move:function(val){}};for(var index in default_args){if(typeof config[index]==="undefined")config[index]=default_args[index]}var that=this;var length_inner=config.length-2*config.padding;this.shape=new Konva.Group({x:config.x,y:config.y,rotation:config.horizontal?90:0});var back=new Konva.Rect({width:config.breadth,height:config.length,offsetX:config.breadth/2,offsetY:config.length/2,fill:"gray",strokeWidth:0,opacity:.1});var back_drawn=new Konva.Rect({width:config.breadth/8,height:length_inner,offsetX:config.breadth/16,offsetY:length_inner/2,fill:"gray",strokeWidth:0,listening:false});var nub=new Konva.Rect({x:0,y:0,width:config.breadth/2,height:config.breadth/2,offsetX:config.breadth/4,offsetY:config.breadth/4,fill:"black",strokeWidth:0,listening:false});var _changeValue=function(){var mpos=Controller.getPointerRelativePosition(that.shape);var val=config.horizontal?-mpos.x:mpos.y;val=coerce(val,-length_inner/2,length_inner/2);config.on_move(-2*val/length_inner);nub.position({x:0,y:val});Controller.layer.draw()};back.on("mousedown touchstart",function(){_changeValue()});back.on("mousemove touchmove",function(){_changeValue()});back.on("mouseup touchend",function(){if(config.spring){var pos={x:0,y:0};config.on_move(0);nub.position(pos);Controller.layer.draw()}});this.shape.add(back);this.shape.add(back_drawn);this.shape.add(nub)};Controller.Button=function(config){var default_args={size:50,color_on:"green",color_off:"gray",on_press:function(btn){}};for(var index in default_args){if(typeof config[index]==="undefined")config[index]=default_args[index]}var that=this;this.state=false;this.shape=new Konva.Rect({x:config.x,y:config.y,width:config.size,height:config.size,offsetX:config.size/2,offsetY:config.size/2,fill:config.color_off,strokeWidth:1});this.shape.on("mousedown touchstart",function(){config.on_press(that)});this._setState=function(state){that.state=state;var color=state?config.color_on:config.color_off;this.shape.fill(color);this.shape.draw()}};Controller.Button.prototype={setState:function(state){this._setState(state)}}})();var wsComm=function(){"use strict";var _ws=null;var _ws_uri="";var _connected=false;var _try_reconnect=true;var _onMessage=null;function _connect(){_ws=new WebSocket(_ws_uri);_ws.binaryType="arraybuffer";_ws.onopen=function(evt){_onOpen(evt)};_ws.onclose=function(evt){_onClose(evt)};_ws.onmessage=function(evt){_onMessage(evt.data)};_ws.onerror=function(evt){_onError(evt)}}function _onOpen(evt){_connected=true}function _onClose(evt){_connected=false;if(_try_reconnect){setTimeout(function(){_connect()},3e3)}}function _onError(evt){console.log("Error creating Websocket connection: "+evt);_connected=false;if(_try_reconnect){setTimeout(function(){_connect()},3e3)}}var init=function(wsUri,onMessage){_ws_uri=wsUri;_onMessage=onMessage;_connect()};var send=function(data){if(_connected){_ws.send(data)}};var close=function(){_try_reconnect=false;if(_connected){_ws.close()}};return{init:init,connected:_connected,send:send,close:close}}();